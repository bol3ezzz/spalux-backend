<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaLux - لوحة الإدخال</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #90EE90, #FFD700); padding: 20px; color: white; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; }
        .form-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group.full { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; transition: border 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #90EE90; }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        button { background: #90EE90; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
        button:hover { background: #7FDD7F; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .ads-list { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .ad-item { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
        .ad-item:hover { background: #f9f9f9; }
        .ad-item:last-child { border-bottom: none; }
        .ad-info { flex: 1; }
        .ad-info h3 { margin-bottom: 5px; color: #333; }
        .ad-info p { color: #666; font-size: 14px; }
        .ad-actions { display: flex; gap: 10px; }
        .btn-delete { background: #ff4444; padding: 8px 15px; font-size: 14px; }
        .btn-delete:hover { background: #cc0000; }
        .btn-toggle { background: #FFA500; padding: 8px 15px; font-size: 14px; }
        .btn-toggle:hover { background: #FF8C00; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 24px; margin-bottom: 5px; color: #90EE90; }
        .stat-card p { color: #666; font-size: 14px; }
        .image-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .preview-img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; border: 2px solid #ddd; }
        .preview-video { width: 200px; height: 120px; border-radius: 5px; border: 2px solid #ddd; }
        .remove-file { position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; }
        .file-item { position: relative; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #90EE90; }
        input:checked + .slider:before { transform: translateX(24px); }
        .social-inputs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 768px) {
            .form-row, .social-inputs { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>لوحة إدارة الإعلانات - SpaLux</h1>
    </div>

    <div class="container">
        <div id="message" style="display: none;"></div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalAds">0</h3>
                <p>إجمالي الإعلانات</p>
            </div>
            <div class="stat-card">
                <h3 id="activeAds">0</h3>
                <p>الإعلانات النشطة</p>
            </div>
            <div class="stat-card">
                <h3 id="inactiveAds">0</h3>
                <p>الإعلانات الموقوفة</p>
            </div>
            <div class="stat-card">
                <h3 id="expiringSoon">0</h3>
                <p>تنتهي قريباً</p>
            </div>
        </div>

        <div class="form-card">
            <h2>إضافة إعلان جديد</h2>
            <form id="adForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>الاسم (عربي) *</label>
                        <input type="text" name="nameAr" required>
                    </div>
                    <div class="form-group">
                        <label>الاسم (إنجليزي) *</label>
                        <input type="text" name="nameEn" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>الوصف (عربي) *</label>
                        <textarea name="descriptionAr" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>الوصف (إنجليزي) *</label>
                        <textarea name="descriptionEn" required></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>الفئة *</label>
                        <select name="category" required>
                            <option value="">اختر الفئة</option>
                            <option value="men">رجال</option>
                            <option value="women">نساء</option>
                            <option value="children">أطفال</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>التصنيف الفرعي *</label>
                        <select name="subCategory" required>
                            <option value="">اختر التصنيف</option>
                            <option value="spa">سبا</option>
                            <option value="cupping">حجامة</option>
                            <option value="beauty_clinic">عيادة تجميل</option>
                            <option value="mens_salon">صالون رجالي</option>
                            <option value="womens_salon">صالون نسائي</option>
                            <option value="home_services">خدمات منزلية</option>
                            <option value="body_care">عناية بالجسم</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>المحافظة *</label>
                        <select name="governorate" required>
                            <option value="">اختر المحافظة</option>
                            <option value="capital">العاصمة</option>
                            <option value="hawalli">حولي</option>
                            <option value="farwaniya">الفروانية</option>
                            <option value="mubarak_alkabeer">مبارك الكبير</option>
                            <option value="ahmadi">الأحمدي</option>
                            <option value="jahra">الجهراء</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>تاريخ انتهاء الاشتراك *</label>
                        <input type="date" name="subscriptionEndDate" required>
                    </div>
                </div>

                <div class="form-group full">
                    <label>ترتيب العرض (اختياري)</label>
                    <input type="number" name="displayOrder" min="0" placeholder="كلما زاد الرقم كلما ظهر أولاً">
                </div>

                <div class="form-group full">
                    <label>الصور (حد أقصى 10) *</label>
                    <input type="file" name="images" accept="image/*" multiple required>
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <div class="form-group full">
                    <label>الفيديوهات (حد أقصى 2)</label>
                    <input type="file" name="videos" accept="video/*" multiple>
                    <div id="videoPreview" class="image-preview"></div>
                </div>

                <div class="form-group full">
                    <h3>روابط التواصل الاجتماعي (اختياري)</h3>
                    <div class="social-inputs">
                        <input type="url" name="facebook" placeholder="فيسبوك">
                        <input type="url" name="instagram" placeholder="إنستغرام">
                        <input type="url" name="twitter" placeholder="تويتر">
                        <input type="url" name="snapchat" placeholder="سناب شات">
                        <input type="url" name="tiktok" placeholder="تيك توك">
                        <input type="url" name="whatsapp" placeholder="واتساب (رقم الهاتف)">
                        <input type="tel" name="phone" placeholder="رقم الهاتف">
                        <input type="url" name="website" placeholder="الموقع الإلكتروني">
                        <input type="url" name="mapLink" placeholder="رابط الخريطة">
                    </div>
                </div>

                <button type="submit" id="submitBtn">إضافة الإعلان</button>
            </form>
        </div>

        <div class="ads-list">
            <h2>الإعلانات الحالية</h2>
            <div id="adsContainer">
                <div class="loading">جاري تحميل الإعلانات...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api/admin';

        document.getElementById('adForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'جاري الإضافة...';

            const formData = new FormData(e.target);

            try {
                const res = await fetch(`${API_URL}/advertisements`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showMessage('تم إضافة الإعلان بنجاح!', 'success');
                    e.target.reset();
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('videoPreview').innerHTML = '';
                    loadAds();
                } else {
                    showMessage('خطأ: ' + (data.message || 'فشل في إضافة الإعلان'), 'error');
                }
            } catch (error) {
                showMessage('خطأ في الاتصال بالسيرفر. تأكد من تشغيل Backend', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'إضافة الإعلان';
            }
        });

        async function loadAds() {
            const container = document.getElementById('adsContainer');
            container.innerHTML = '<div class="loading">جاري تحميل الإعلانات...</div>';

            try {
                const res = await fetch(`${API_URL}/advertisements`);
                const data = await res.json();

                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(ad => `
                        <div class="ad-item">
                            <div class="ad-info">
                                <h3>${ad.nameAr} - ${ad.subCategory.replace('_', ' ')}</h3>
                                <p>${ad.category} | ${ad.governorate} | ${new Date(ad.subscriptionEndDate).toLocaleDateString('ar-KW')}</p>
                                <p style="color: ${ad.isActive ? 'green' : 'red'}; font-weight: bold;">
                                    ${ad.isActive ? 'نشط' : 'موقوف'}
                                </p>
                            </div>
                            <div class="ad-actions">
                                <button class="btn-toggle" onclick="toggleAd('${ad._id}', ${ad.isActive})">
                                    ${ad.isActive ? 'إيقاف' : 'تفعيل'}
                                </button>
                                <button class="btn-delete" onclick="deleteAd('${ad._id}')">حذف</button>
                            </div>
                        </div>
                    `).join('');
                    
                    updateStats(data.data);
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">لا توجد إعلانات حالياً</p>';
                    updateStats([]);
                }
            } catch (error) {
                container.innerHTML = '<p class="error">فشل في تحميل الإعلانات. تأكد من تشغيل السيرفر.</p>';
                updateStats([]);
            }
        }

        function updateStats(ads) {
            const total = ads.length;
            const active = ads.filter(ad => ad.isActive).length;
            const inactive = total - active;
            const today = new Date();
            const expiringSoon = ads.filter(ad => {
                const end = new Date(ad.subscriptionEndDate);
                const diff = (end - today) / (1000 * 60 * 60 * 24);
                return diff <= 7 && diff >= 0;
            }).length;

            document.getElementById('totalAds').textContent = total;
            document.getElementById('activeAds').textContent = active;
            document.getElementById('inactiveAds').textContent = inactive;
            document.getElementById('expiringSoon').textContent = expiringSoon;
        }

        async function toggleAd(id, currentStatus) {
            try {
                const res = await fetch(`${API_URL}/advertisements/${id}/toggle`, {
                    method: 'PATCH'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showMessage(`${currentStatus ? 'تم إيقاف' : 'تم تفعيل'} الإعلان بنجاح!`, 'success');
                    loadAds();
                } else {
                    showMessage('خطأ: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('خطأ في الاتصال بالسيرفر', 'error');
            }
        }

        async function deleteAd(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الإعلان؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            try {
                const res = await fetch(`${API_URL}/advertisements/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showMessage('تم حذف الإعلان بنجاح!', 'success');
                    loadAds();
                } else {
                    showMessage('خطأ: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('خطأ في الاتصال بالسيرفر', 'error');
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.className = type;
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        const dateInput = document.querySelector('input[name="subscriptionEndDate"]');
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 30);
        dateInput.value = defaultDate.toISOString().split('T')[0];
        dateInput.min = new Date().toISOString().split('T')[0];

        document.querySelector('input[name="images"]').addEventListener('change', previewFiles);
        document.querySelector('input[name="videos"]').addEventListener('change', previewFiles);

        function previewFiles(e) {
            const files = e.target.files;
            const previewId = e.target.name === 'images' ? 'imagePreview' : 'videoPreview';
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        img.className = 'preview-img';
                        div.appendChild(img);
                    } else if (file.type.startsWith('video/')) {
                        const video = document.createElement('video');
                        video.src = ev.target.result;
                        video.className = 'preview-video';
                        video.muted = true;
                        video.controls = true;
                        div.appendChild(video);
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-file';
                    removeBtn.textContent = '×';
                    removeBtn.onclick = () => {
                        const dt = new DataTransfer();
                        Array.from(e.target.files).forEach((f, i) => {
                            if (i !== index) dt.items.add(f);
                        });
                        e.target.files = dt.files;
                        previewFiles(e);
                    };
                    div.appendChild(removeBtn);
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        loadAds();
    </script>
</body>
</html>